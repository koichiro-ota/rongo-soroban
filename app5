import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import time

# ---------------------------------------------------------
# è¨­å®šã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
# ---------------------------------------------------------
st.set_page_config(page_title="Perennial Insight AI", layout="wide")

if 'answers' not in st.session_state:
    st.session_state['answers'] = None
if 'user_profile' not in st.session_state:
    st.session_state['user_profile'] = {"name": "ç›¸ç”° å¥å¤ª", "age": 42, "dept": "å–¶æ¥­æ¨é€²éƒ¨"}

# æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œï¼ˆMatplotlibç”¨: ç’°å¢ƒã«ã‚ˆã£ã¦ã¯æ–‡å­—åŒ–ã‘ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€è‹±èªè¡¨è¨˜ã«ã™ã‚‹ã‹ãƒ•ã‚©ãƒ³ãƒˆæŒ‡å®šãŒå¿…è¦ã§ã™ãŒã€ä»Šå›ã¯æ¨™æº–ã§å‹•ãç¯„å›²ã§å®Ÿè£…ï¼‰
plt.rcParams['font.family'] = 'sans-serif'

# ---------------------------------------------------------
# ãƒ­ã‚¸ãƒƒã‚¯å®šç¾©ï¼ˆAIåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
# ---------------------------------------------------------

# è³ªå•é …ç›®ã¨ã‚«ãƒ†ã‚´ãƒªã®å®šç¾©
QUESTIONS = [
    {"id": "q1", "cat": "Relevance", "text": "ç¾åœ¨ã®ã‚¹ã‚­ãƒ«ã ã‘ã§ã€ä»Šå¾Œ3ã€œ5å¹´ã‚‚ç¬¬ä¸€ç·šã§æˆæœã‚’å‡ºã›ã‚‹ã¨æ„Ÿã˜ã‚‹ï¼ˆé€†è»¢é …ç›®ï¼‰", "reverse": True},
    {"id": "q2", "cat": "Relevance", "text": "ç¤¾å¤–ï¼ˆåŠ´åƒå¸‚å ´ï¼‰ã§ã‚‚é€šç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã‚ã‚ŠãŸã„ã¨ã„ã†å¼·ã„æ€ã„ãŒã‚ã‚‹"},
    {"id": "q3", "cat": "Relevance", "text": "è‡ªåˆ†ã®å½¹å‰²ã‚’ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã‹ã‚‰ã€Œå¤‰é©è€…ã€ã¸ã‚·ãƒ•ãƒˆã™ã‚‹å¿…è¦æ€§ã‚’æ„Ÿã˜ã¦ã„ã‚‹"},
    {"id": "q4", "cat": "Flexibility", "text": "å°‚é–€å¤–ã®åˆ†é‡ã‚„ã€æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰ã«ç©æ¥µçš„ã«é–¢å¿ƒã‚’æŒã£ã¦ã„ã‚‹"},
    {"id": "q5", "cat": "Flexibility", "text": "éå»ã«æˆåŠŸã—ãŸã‚„ã‚Šæ–¹ã§ã‚‚ã€ç’°å¢ƒãŒå¤‰ã‚ã‚Œã°æ¨ã¦ã¦æ–°ã—ã„æ–¹æ³•ã‚’è©¦ã›ã‚‹"},
    {"id": "q6", "cat": "Flexibility", "text": "å¹´ä¸‹ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚„ä»–éƒ¨ç½²ã‹ã‚‰ã®æŒ‡æ‘˜ã‚’ã€æˆé•·ã®ç³§ã¨ã—ã¦ç´ ç›´ã«å—ã‘æ­¢ã‚ã‚‰ã‚Œã‚‹"},
    {"id": "q7", "cat": "Resources", "text": "æ¥­å‹™åŠ¹ç‡åŒ–ã‚„æ¨©é™å§”è­²ã‚’é€šã˜ã¦ã€è‡ªåˆ†ã®å­¦ç¿’æ™‚é–“ã‚’æ»å‡ºã™ã‚‹å·¥å¤«ã‚’ã—ã¦ã„ã‚‹"},
    {"id": "q8", "cat": "Resources", "text": "å­¦ã‚“ã æ–°ã—ã„çŸ¥è­˜ã‚’ã€ç¿Œæ—¥ã®å®Ÿå‹™ã§ã™ãã«è©¦ã—ã¦ã¿ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ã"},
    {"id": "q9", "cat": "Resources", "text": "æ–°ã—ã„ã‚¹ã‚­ãƒ«ç¿’å¾—ã®ãŸã‚ã®ä¸€æ™‚çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã‚’è¨±å®¹ã§ãã‚‹"},
    {"id": "q10", "cat": "Motivation", "text": "æœ€è¿‘ã€æ–°ã—ã„ã“ã¨ã‚’çŸ¥ã£ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã€Œãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã€æ„Ÿè¦šãŒã‚ã‚‹"},
    {"id": "q11", "cat": "Motivation", "text": "ä»Šå›ã®å­¦ç¿’ã¯ã€è‡ªåˆ†ã®äººç”Ÿã®ç›®çš„ã‚„å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³ã¨ã¤ãªãŒã£ã¦ã„ã‚‹"}
]

def analyze_type(scores):
    """ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦4ã¤ã®ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯"""
    # ã‚«ãƒ†ã‚´ãƒªåˆ¥å¹³å‡ç‚¹ã®è¨ˆç®—
    cat_scores = {"Relevance": 0, "Flexibility": 0, "Resources": 0, "Motivation": 0}
    counts = {"Relevance": 0, "Flexibility": 0, "Resources": 0, "Motivation": 0}

    for q, score in scores.items():
        # é€†è»¢é …ç›®ã®å‡¦ç†ï¼ˆ1->5, 5->1ï¼‰
        val = score
        item = next((x for x in QUESTIONS if x["id"] == q), None)
        if item and item.get("reverse"):
            val = 6 - val
        
        cat_scores[item["cat"]] += val
        counts[item["cat"]] += 1
    
    # å¹³å‡åŒ–
    avgs = {k: v / counts[k] for k, v in cat_scores.items()}
    
    # ã‚¿ã‚¤ãƒ—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    # ã—ãã„å€¤: 3.0
    if avgs["Relevance"] < 3.0 and avgs["Flexibility"] < 3.0:
        return "éå»ã®æ „å…‰å‹", avgs
    elif avgs["Relevance"] >= 3.5 and avgs["Resources"] < 3.0:
        return "ç‡ƒãˆå°½ãå¯¸å‰å‹", avgs
    elif avgs["Motivation"] >= 3.5 and avgs["Relevance"] < 3.0:
        return "è¿·èµ°å‹", avgs
    elif all(v >= 3.5 for v in avgs.values()):
        return "è‡ªå¾‹å­¦ç¿’å‹", avgs
    else:
        return "åœæ»äºˆå‚™è»å‹ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰", avgs

def generate_script(type_name, free_text):
    """ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‡¦æ–¹ç®‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆ"""
    
    # è‡ªç”±è¨˜è¿°ã®ç°¡æ˜“æ„Ÿæƒ…åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    sentiment_note = ""
    if "å¿™ã—ã„" in free_text or "æ™‚é–“" in free_text:
        sentiment_note = "â€»ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã€Œæ™‚é–“çš„ä½™è£•ã®ãªã•ã€ã«ã‚ˆã‚‹ç„¦ã‚ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å…±æ„Ÿã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚"
    elif "è‡ªä¿¡" in free_text or "çµŒé¨“" in free_text:
        sentiment_note = "â€»ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã€Œéå»ã®å®Ÿç¸¾ã¸ã®è‡ªè² ã€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’å‚·ã¤ã‘ãªã„ã‚ˆã†é…æ…®ãŒå¿…è¦ã§ã™ã€‚"
    else:
        sentiment_note = "â€»ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç‰¹æ®µã®ãƒã‚¬ãƒ†ã‚£ãƒ–è¦ç´ ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æœªæ¥å¿—å‘ã®å¯¾è©±ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚"

    scripts = {
        "éå»ã®æ „å…‰å‹": {
            "summary": "éå»ã®å®Ÿç¸¾ã«è‡ªä¿¡ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€å¤‰åŒ–ã¸ã®æ„Ÿåº¦ãŒéˆã£ã¦ã„ã¾ã™ã€‚ã€Œä»Šã®ã‚„ã‚Šæ–¹ã§ååˆ†ã€ã¨ã„ã†æ…¢å¿ƒãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚",
            "approach": "æ•¬æ„ã‚’æ‰•ã„æ‰¿èªã—ã¤ã¤ã€ã€Œå¤–éƒ¨ç’°å¢ƒã®å¤‰åŒ–ã€ã‚„ã€Œå¸‚å ´ä¾¡å€¤ã€ã«ç›®ã‚’å‘ã‘ã•ã›ã€å±æ©Ÿæ„Ÿã‚’é†¸æˆã™ã‚‹ã€‚",
            "step1": "ã“ã‚Œã¾ã§ã®å®Ÿç¸¾ã‚„ã€ç‹¬è‡ªã®å·¥å¤«ã«ã¤ã„ã¦æ·±ããƒ’ã‚¢ãƒªãƒ³ã‚°ã—ã€æ‰¿èªã™ã‚‹ï¼ˆè‡ªä¿¡ã®æºæ³‰ã‚’ç‰¹å®šï¼‰ã€‚",
            "step2": "ã€Œã‚‚ã—ä»Šã®ä¼šç¤¾ãŒæ˜æ—¥ãªããªã£ãŸã‚‰ã€ã©ã®ã‚¹ã‚­ãƒ«ãŒå¸‚å ´ã§ä¸€ç•ªé«˜ãå£²ã‚Œã‚‹ã¨æ€ã†ã‹ï¼Ÿã€ã¨å•ã„ã‹ã‘ã‚‹ã€‚",
            "step3": "ã‚ãˆã¦è‹¥æ‰‹ã®ãƒ¡ãƒ³ã‚¿ãƒ¼ã«ã¤ããªã©ã€æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’æ•™ã‚ã‚‹ç«‹å ´ï¼ˆãƒªãƒãƒ¼ã‚¹ãƒ¡ãƒ³ã‚¿ãƒªãƒ³ã‚°ï¼‰ã‚’ææ¡ˆã™ã‚‹ã€‚"
        },
        "ç‡ƒãˆå°½ãå¯¸å‰å‹": {
            "summary": "ã‚„ã‚‹æ°—ã‚‚å¿…è¦æ€§ã‚‚æ„Ÿã˜ã¦ã„ã¾ã™ãŒã€ç¾å ´ã«å¿™æ®ºã•ã‚Œã€ç‰©ç†çš„ãƒ»ç²¾ç¥çš„ãªãƒªã‚½ãƒ¼ã‚¹ãŒæ¯æ¸‡ã—ã¦ã„ã¾ã™ã€‚",
            "approach": "æ–°ã—ã„å­¦ç¿’ã‚’ä¿ƒã™å‰ã«ã€ã¾ãšã¯ã€Œæ¥­å‹™ã®å¼•ãç®—ã€ã¨ã€Œå¿ƒç†çš„å®‰å…¨æ€§ã€ã‚’æä¾›ã™ã‚‹ã€‚",
            "step1": "ã€Œæœ€è¿‘ã€çœ ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€ã€Œæ¥­å‹™é‡ã§ç„¡ç†ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã¯ãªã„ã§ã™ã‹ï¼Ÿã€ã¨ã‚±ã‚¢ã‹ã‚‰å…¥ã‚‹ã€‚",
            "step2": "å­¦ç¿’ã®ãŸã‚ã®æ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€ä»Šã‚„ã‚ã‚‹ã¹ãæ¥­å‹™ã‚„ã€éƒ¨ä¸‹ã«ä»»ã›ã‚‰ã‚Œã‚‹æ¥­å‹™ã‚’ä¸€ç·’ã«æ£šå¸ã—ã™ã‚‹ã€‚",
            "step3": "ã€Œä»Šã¯ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã®æ™‚æœŸã§ã¯ãªãã€æ•´ãˆã‚‹æ™‚æœŸã€ã¨ä¼ãˆã€ç„¦ã‚Šã‚’å–ã‚Šé™¤ãã€‚"
        },
        "è¿·èµ°å‹": {
            "summary": "å­¦ç¿’æ„æ¬²ã¯é«˜ã„ã‚‚ã®ã®ã€å®Ÿå‹™ã‚„ã‚­ãƒ£ãƒªã‚¢ã®æ–¹å‘æ€§ã¨ä¹–é›¢ã—ãŸè³‡æ ¼å–å¾—ãªã©ã«èµ°ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "approach": "å­¦ç¿’ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ã€çµ„ç¹”ã®æˆæœã‚„å€‹äººã®æœ¬è³ªçš„ãªã‚­ãƒ£ãƒªã‚¢ç›®æ¨™ã«æ¥ç¶šã—ç›´ã™ï¼ˆæ„å‘³ã¥ã‘ï¼‰ã€‚",
            "step1": "æœ€è¿‘å­¦ã‚“ã§ã„ã‚‹ã“ã¨ã¸ã®ç†±æ„ã‚’ç§°è³›ã™ã‚‹ã€‚",
            "step2": "ã€Œãã®å­¦ã³ã‚’ã€ä»Šã®ãƒãƒ¼ãƒ ã®èª²é¡Œè§£æ±ºã«æ´»ã‹ã™ã¨ã—ãŸã‚‰ã€ã©ã‚“ãªä½¿ã„æ–¹ãŒã§ããã†ï¼Ÿã€ã¨å®Ÿå‹™ã¸ã®è»¢ç”¨ã‚’å•ã†ã€‚",
            "step3": "3å¹´å¾Œã®ç†æƒ³ã®å§¿ã‹ã‚‰é€†ç®—ã—ã€ä»Šæœ¬å½“ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã‚’ä¸€ç·’ã«å†å®šç¾©ã™ã‚‹ã€‚"
        },
        "è‡ªå¾‹å­¦ç¿’å‹": {
            "summary": "éå¸¸ã«é«˜ã„å­¦ç¿’æ„æ¬²ã¨å®Ÿè¡ŒåŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç¾çŠ¶ã®ç’°å¢ƒã§ã¯ç‰©è¶³ã‚Šãªã•ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
            "approach": "ã•ã‚‰ãªã‚‹ã€Œä¿®ç¾…å ´ï¼ˆã‚¹ãƒˆãƒ¬ãƒƒãƒèª²é¡Œï¼‰ã€ã‚’æä¾›ã—ã€çµ„ç¹”ã®å¤‰é©ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦ã‚¹ãƒãƒ³ã‚µãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹ã€‚",
            "step1": "ç¾çŠ¶ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨å­¦ç¿’å§¿å‹¢ã‚’é«˜ãè©•ä¾¡ã™ã‚‹ã€‚",
            "step2": "ã€Œä»Šã®æ¥­å‹™ã§ã€ç‰©è¶³ã‚Šãªã•ã‚„é€€å±ˆã‚’æ„Ÿã˜ã¦ã„ã‚‹éƒ¨åˆ†ã¯ãªã„ã‹ï¼Ÿã€ã¨ç‡ç›´ã«èãã€‚",
            "step3": "æ–°è¦äº‹æ¥­ã‚„å…¨ç¤¾æ¨ªæ–­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã©ã€ã‚ˆã‚Šé›£æ˜“åº¦ã®é«˜ã„å½¹å‰²ã¸ã®æŠœæ“¢ã‚’æ‰“è¨ºã™ã‚‹ã€‚"
        },
        "åœæ»äºˆå‚™è»å‹ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰": {
            "summary": "å¤§ããªå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€çªãæŠœã‘ãŸå‹•æ©Ÿã‚‚è¦‹å½“ãŸã‚Šã¾ã›ã‚“ã€‚ç¾çŠ¶ç¶­æŒãƒã‚¤ã‚¢ã‚¹ãŒã‹ã‹ã‚Šå§‹ã‚ã¦ã„ã¾ã™ã€‚",
            "approach": "ã€Œå°‘ã—ã ã‘èƒŒä¼¸ã³ã‚’ã™ã‚‹ã€ç›®æ¨™ã‚’è¨­å®šã—ã€å°ã•ãªå¤‰åŒ–ã‚’èµ·ã“ã™ã€‚",
            "step1": "ç¾çŠ¶ã®å®‰å®šæ„Ÿã‚’è©•ä¾¡ã—ã¤ã¤ã€ãƒãƒ³ãƒãƒªåŒ–ã—ã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹ã€‚",
            "step2": "ã€Œã“ã®1å¹´ã§ã€ä¸€ç•ªãƒ¯ã‚¯ãƒ¯ã‚¯ã—ãŸä»•äº‹ã¯ä½•ï¼Ÿã€ã¨å•ã„ã‹ã‘ã€æ„Ÿæƒ…ãŒå‹•ããƒã‚¤ãƒ³ãƒˆã‚’æ¢ã‚‹ã€‚",
            "step3": "ä»Šé€±ä¸­ã«ä¸€ã¤ã ã‘ã€ã€Œã„ã¤ã‚‚ã®ã‚„ã‚Šæ–¹ã‚’å¤‰ãˆã¦ã¿ã‚‹ã€å®Ÿé¨“ã‚’ææ¡ˆã™ã‚‹ã€‚"
        }
    }
    
    return scripts.get(type_name, scripts["åœæ»äºˆå‚™è»å‹ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰"]), sentiment_note

# ---------------------------------------------------------
# UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
# ---------------------------------------------------------

def render_radar_chart(avgs):
    """ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®æç”»"""
    categories = list(avgs.keys())
    values = list(avgs.values())
    values += values[:1] # é–‰ã˜ã‚‹ãŸã‚ã«å…ˆé ­ã‚’è¿½åŠ 
    
    angles = np.linspace(0, 2 * np.pi, len(categories), endpoint=False).tolist()
    angles += angles[:1]
    
    fig, ax = plt.subplots(figsize=(4, 4), subplot_kw=dict(polar=True))
    ax.fill(angles, values, color='#4A90E2', alpha=0.25)
    ax.plot(angles, values, color='#4A90E2', linewidth=2)
    
    # ç›®ç››ã‚Šè¨­å®š
    ax.set_yticklabels([])
    ax.set_xticks(angles[:-1])
    ax.set_xticklabels(categories, fontsize=10)
    ax.set_ylim(0, 5)
    
    return fig

# ---------------------------------------------------------
# ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
# ---------------------------------------------------------

st.sidebar.image("https://placehold.co/200x60?text=Perennial+AI", caption="Sustainable Career Support")
role = st.sidebar.radio("ãƒ¢ãƒ¼ãƒ‰é¸æŠ", ["åˆ©ç”¨è€…ï¼ˆç¤¾å“¡ï¼‰", "ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ï¼ˆä¸Šå¸ãƒ»HRï¼‰"])

# --- åˆ©ç”¨è€…ãƒ¢ãƒ¼ãƒ‰ ---
if role == "åˆ©ç”¨è€…ï¼ˆç¤¾å“¡ï¼‰":
    st.title("ğŸŒ± å­¦ç¿’æ„æ¬²ãƒ»ã‚­ãƒ£ãƒªã‚¢è‡ªå¾‹ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ")
    st.markdown(f"**å¯¾è±¡è€…:** {st.session_state['user_profile']['dept']} / {st.session_state['user_profile']['name']} æ§˜")
    st.info("ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯ã€ã‚ãªãŸã®ç¾åœ¨ã®ã‚­ãƒ£ãƒªã‚¢è¦³ã¨å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¯è¦–åŒ–ã—ã€ã‚ˆã‚Šè‰¯ã„ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚æ­£ç›´ã«ãŠç­”ãˆãã ã•ã„ã€‚")

    with st.form("assessment_form"):
        st.subheader("Q1. ã‚­ãƒ£ãƒªã‚¢ã¨å­¦ç¿’ã«é–¢ã™ã‚‹è³ªå•")
        
        input_scores = {}
        for q in QUESTIONS:
            val = st.slider(f"{q['text']}", 1, 5, 3, key=q['id'])
            input_scores[q['id']] = val
            st.markdown("---")
        
        st.subheader("Q2. è‡ªç”±è¨˜è¿°")
        free_comment = st.text_area("ç›´è¿‘1å¹´é–“ã§ã€ã€Œè‡ªåˆ†ã®ã‚„ã‚Šæ–¹ãŒã‚‚ã†å¤ã„ã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ãƒãƒƒã¨ã—ãŸç¬é–“ã‚„ã€å­¦ç¿’ã‚’é˜»å®³ã—ã¦ã„ã‚‹ã€Œå£ã€ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚", height=100)
        
        submitted = st.form_submit_button("å›ç­”ã‚’é€ä¿¡ã—ã¦åˆ†æã™ã‚‹")
        
        if submitted:
            st.session_state['answers'] = input_scores
            st.session_state['free_comment'] = free_comment
            st.success("å›ç­”ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚AIãŒåˆ†æã‚’é–‹å§‹ã—ã¾ã™...ï¼ˆã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ï¼‰")

# --- ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰ ---
else:
    st.title("ğŸ“‹ Perennial Insight AI - è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ")
    
    if st.session_state['answers'] is None:
        st.warning("ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€Œåˆ©ç”¨è€…ãƒ¢ãƒ¼ãƒ‰ã€ã§å›ç­”ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚")
        # ãƒ‡ãƒ¢ç”¨ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ãƒœã‚¿ãƒ³
        if st.button("ãƒ‡ãƒ¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰"):
            dummy_scores = {q['id']: np.random.randint(1, 5) for q in QUESTIONS}
            # ç‰¹å®šã®ã‚¿ã‚¤ãƒ—ï¼ˆéå»ã®æ „å…‰å‹ï¼‰ã«ãªã‚Šã‚„ã™ã„ã‚ˆã†ã«èª¿æ•´
            dummy_scores['q1'] = 4 # é€†è»¢å‰ãªã®ã§ã€Œä»Šã®ã¾ã¾ã§ã„ã„ã€ãŒé«˜ã„ -> 2
            dummy_scores['q4'] = 2 # æ–°ã—ã„ã“ã¨ã«é–¢å¿ƒãªã—
            dummy_scores['q5'] = 2 # éå»ã‚’æ¨ã¦ã‚‰ã‚Œãªã„
            st.session_state['answers'] = dummy_scores
            st.session_state['free_comment'] = "ä»Šã®æ¥­å‹™ã¯éå¸¸ã«å¿™ã—ãã€ã“ã‚Œã¾ã§ã®çµŒé¨“ã§å›ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã®å°å…¥ã‚ˆã‚Šã‚‚ã€ä»Šã®å–¶æ¥­ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‹¥æ‰‹ã«æ•™ãˆã‚‹æ–¹ãŒé‡è¦ã ã¨æ€ã„ã¾ã™ã€‚"
            st.rerun()
    else:
        # åˆ†æå®Ÿè¡Œ
        with st.spinner('AIãŒå›ç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨è¨€èªæ„Ÿæƒ…ã‚’åˆ†æä¸­...'):
            time.sleep(1.5) # AIã®å‡¦ç†æ„Ÿã‚’æ¼”å‡º
            type_name, avgs = analyze_type(st.session_state['answers'])
            script_data, sentiment_note = generate_script(type_name, st.session_state['free_comment'])

        # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
        col1, col2 = st.columns([1, 3])
        with col1:
            st.image("https://placehold.co/150x150?text=User", width=120)
        with col2:
            st.markdown(f"### {st.session_state['user_profile']['name']} ({st.session_state['user_profile']['age']}æ­³)")
            st.markdown(f"**éƒ¨ç½²:** {st.session_state['user_profile']['dept']}")
            st.markdown(f"**è¨ºæ–­ã‚¿ã‚¤ãƒ—:** <span style='color:red; font-size:20px; font-weight:bold;'>{type_name}</span>", unsafe_allow_html=True)

        st.markdown("---")

        # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        col_chart, col_text = st.columns([1, 1])
        
        with col_chart:
            st.subheader("ğŸ“Š ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒ©ãƒ³ã‚¹")
            fig = render_radar_chart(avgs)
            st.pyplot(fig)
        
        with col_text:
            st.subheader("ğŸ” AIåˆ†æã‚µãƒãƒª")
            st.markdown(f"> **{script_data['summary']}**")
            st.info(sentiment_note)
            with st.expander("ç¤¾å“¡ã®è‡ªç”±è¨˜è¿°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹"):
                st.text(st.session_state['free_comment'])

        st.markdown("---")

        # å¯¾è©±æˆ¦ç•¥ã‚·ãƒ¼ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰
        st.header("ğŸ’¬ 1on1 å¯¾è©±æˆ¦ç•¥ã‚·ãƒ¼ãƒˆï¼ˆå‡¦æ–¹ç®‹ï¼‰")
        st.markdown("ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‚è€ƒã«ã€æ¬¡å›ã®é¢è«‡ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚")

        st.success(f"**åŸºæœ¬ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:** {script_data['approach']}")

        tab1, tab2, tab3 = st.tabs(["Step 1: ã‚¢ã‚¤ã‚¹ãƒ–ãƒ¬ã‚¤ã‚¯", "Step 2: å•ã„ã‹ã‘", "Step 3: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"])
        
        with tab1:
            st.markdown("#### æ‰¿èªã¨ä¿¡é ¼å½¢æˆ")
            st.markdown(f"- ğŸ—£ï¸ **Script:** ã€Œ{script_data['step1']}ã€")
            st.caption("Point: ã¾ãšã¯ç›¸æ‰‹ã®ç¾çŠ¶ã‚’å¦å®šã›ãšã€å—ã‘æ­¢ã‚ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚")
            
        with tab2:
            st.markdown("#### èªè­˜ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’åŸ‹ã‚ã‚‹")
            st.markdown(f"- ğŸ—£ï¸ **Script:** ã€Œ{script_data['step2']}ã€")
            st.caption("Point: AIã®å®¢è¦³çš„ãªãƒ‡ãƒ¼ã‚¿ã‚„ã€ä»®å®šã®è³ªå•ã‚’ä½¿ã£ã¦ã€è¦–ç‚¹ã‚’ãšã‚‰ã—ã¾ã™ã€‚")
            
        with tab3:
            st.markdown("#### è¡Œå‹•è¨ˆç”»ã¨ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°")
            st.markdown(f"- ğŸ—£ï¸ **Script:** ã€Œ{script_data['step3']}ã€")
            st.caption("Point: å¤§ããªç›®æ¨™ã§ã¯ãªãã€æ˜æ—¥ã‹ã‚‰ã§ãã‚‹å°ã•ãªä¸€æ­©ã‚’åˆæ„ã—ã¾ã™ã€‚")

        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½
        st.markdown("---")
        st.caption("ã“ã®åˆ†æã¯å½¹ã«ç«‹ã¡ã¾ã—ãŸã‹ï¼Ÿ")
        c1, c2, c3 = st.columns([1,1,8])
        c1.button("ğŸ‘")
        c2.button("ğŸ‘")
